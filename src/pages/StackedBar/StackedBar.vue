<script setup>
import {
  ref, onMounted, reactive,
} from 'vue';
import stackStore from '../../stores/stack';
import YearSelector from '../../components/YearSelector.vue';
import Tooltip from '../../components/Tooltip.vue';
import Legend from '../../components/Legend.vue';

const stack = stackStore();
const wrapper = ref();
const size = reactive({
  width: 0,
  height: stack.base,
});

onMounted(() => {
  const { width } = wrapper.value.getBoundingClientRect();
  size.width = width - 2 * parseFloat(getComputedStyle(document.documentElement).fontSize);
  stack.setXScale(width);
});
</script>

<template>
  <main @scroll="test" ref="main">
    <YearSelector :default="stack.year" @change="stack.setYear" />
    <section>
      <header ref="header">
        <Legend/>
        <div class="search-wrapper">
          <input type="text" v-model="stack.search">
          <button @click="stack.updateData">Search</button>
        </div>
      </header>
      <div ref="wrapper">
        <p :class="{'stories':true, 'stories-expand': stack.isExpand}" @click="stack.onStoryClick">
          <span>
            This graph shows the total number of deaths and the percentage of different death reasons for each country.
          </span><br><br>
          <span>
            Overall, the total number of deaths in most countries shows an upward trend with each year. 
            This roughly stems from the rise in world population, which is predictable. Each country shows different percentages of death reasons while Cardiovascular Diseases and Neoplasms remain the leading causes of death in the majority of countries. 
            Some countries do not have very high threat level death reasons, only some relatively high threat death reasons, while some countries have much more serious death reasons. 
            This may be closely related to each country's situation, people's diet, climate, and other factors.
          </span>
        </p>
        <RecycleScroller
          class="container"
          :items="stack.data"
          key-field="0"
          :item-size="stack.base"

          v-slot="{ item }"
        >
          <svg
            :width="size.width"
            :height="stack.base"
          >
              <text dominant-baseline="hanging">
                {{item[1][0]}}
              </text>
              <text
                dominant-baseline="hanging"
                text-anchor="end"
                fill="gray"
                :x="size.width"
              >
                Total Death: {{item[1][2]}}
              </text>
              <Tooltip
                v-for="d in stack.getStackedData(item[1])"
                :key="d.key"
              >
                <template #target="{onMouseEnter, onMouseLeave}">
                  <rect
                    :fill="stack.scaleColor(d[0][1] - d[0][0])"
                    stroke="white"
                    :x="stack.x?.(d[0][0]) ?? 0"
                    y="25"
                    :width="stack.x?.(d[0][1] - d[0][0]) ?? 0"
                    height="50"
                    @mouseenter="onMouseEnter"
                    @mouseleave="onMouseLeave"
                  />
                </template>
                <template #content>
                  <div class="tooltip-content">
                    <h4>{{stack.meta[d.key]}}</h4>
                    <p>Year: {{stack.year}}</p>
                    <p>Population: {{item[1][1]}}</p>
                    <p>Death: {{item[1][d.key]}}</p>
                    <p>Death / Population: {{(item[1][3] * 100).toFixed(2)}}%</p>
                    <p>Death / Total Death {{((d[0][1] - d[0][0]) * 100).toFixed(2)}}%</p>
                  </div>
                </template>
              </Tooltip>
          </svg>
        </RecycleScroller>
      </div>
    </section>
  </main>
</template>

<style scoped lang="scss">
p.stories {
  margin: 0rem 2rem 1.5rem 0px;
  background-color:#b9eab5;
  color: #3e8639;
  padding: 1rem 1.5rem;;
  border-radius: 1rem;
  max-height: 1rem;
  transition: max-height 0.5s ease-out;
  overflow: hidden;
  cursor: pointer;
}

p.stories-expand {
  max-height: 100vh;
  transition: max-height 0.5s ease-in;
}

main {
  flex: 1;
  display: flex;
  overflow: auto;
}

section {
  flex: 1;
  overflow-y: auto;
}

header {
  display: flex;
  justify-content: space-between;
  align-content: center;
  align-items: center;
  margin-right: 2rem;
}

rect {
  cursor: pointer;
  transition: all .5s;
}

.hidden {
  display: none;
}

.container {
  height: calc(100vh - 10rem);
}

.search-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem 0;

  input {
    box-sizing: border-box;
    height: 2.5rem;
    outline: none;
    border: 1px solid #DCDFE6;
    border-radius: 8px;
    padding: 0 1rem;
    font-size: 1rem;
    transition: all .3s;

    &:hover {
      border-color: gray;
    }

    &:focus {
      border-color: #409EFF;
    }
  }

  button {
    box-sizing: border-box;
    height: 2.5rem;
    outline: none;
    border: none;
    border-radius: 8px;
    padding: 0 1rem;
    font-size: 1rem;
    transition: all .3s;
    background-color: #409EFF;
    color: white;
    cursor: pointer;

    &:hover {
      background-color: #79bbff;
    }

    &:active {
      background-color: #337ecc;
    }
  }
}
</style>
